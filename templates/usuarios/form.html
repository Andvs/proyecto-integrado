{% extends "inicio.html" %}

{% block page_title %}{% if modo == "crear" %}Nuevo usuario{% else %}Editar usuario{% endif %}{% endblock %}

{% block extra_css %}
<style>
  .password-help {
    background-color: #e7f3ff;
    border-left: 4px solid #0a84c1;
    padding: 12px 15px;
    margin-top: 8px;
    border-radius: 4px;
    font-size: 0.875rem;
  }
  
  .password-help ul {
    margin: 8px 0 0 0;
    padding-left: 20px;
  }
  
  .password-help li {
    margin: 4px 0;
    color: #495057;
  }
  
  /* ✅ Estilos para validación de edad */
  .edad-info {
    background-color: #f0f9ff;
    border-left: 4px solid #0891b2;
    padding: 10px 12px;
    margin-top: 8px;
    border-radius: 4px;
    font-size: 0.875rem;
  }
  
  .edad-warning {
    background-color: #fff7ed;
    border-left: 4px solid #f97316;
    padding: 10px 12px;
    margin-top: 8px;
    border-radius: 4px;
    font-size: 0.875rem;
  }
  
  .categoria-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
    margin-left: 8px;
  }
  
  .categoria-sub14 { background-color: #dbeafe; color: #1e40af; }
  .categoria-sub16 { background-color: #dcfce7; color: #166534; }
  .categoria-sub18 { background-color: #fef3c7; color: #92400e; }
</style>
{% endblock %}

{% block main %}
<div class="container-fluid" style="max-width: 1100px;">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">{% if modo == "crear" %}Crear usuario{% else %}Editar usuario{% endif %}</h4>
    <a href="{% url 'usuarios_lista' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Volver
    </a>
  </div>

  <form method="POST" class="card card-soft p-3" id="formUsuario">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger mb-3">{{ form.non_field_errors|striptags }}</div>
    {% endif %}

    <div class="row g-3">
      <!-- Columna izquierda -->
      <div class="col-12 col-lg-6">
        <!-- ===== Cuenta ===== -->
        <div class="border rounded-3 p-3 mb-3 bg-white">
          <h6 class="text-uppercase text-muted mb-3">Cuenta</h6>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Usuario</label>
              {{ form.username }}
              {% if form.username.errors %}<div class="invalid-feedback d-block">{{ form.username.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-12">
              <label class="form-label">Correo</label>
              {{ form.email }}
              {% with server_error=form.email.errors|striptags %}
                <div
                  id="email-error-feedback"
                  class="invalid-feedback{% if server_error %} d-block{% endif %}"
                  data-server-message="{{ server_error|escape }}"
                  aria-live="polite"
                >
                  {% if server_error %}{{ server_error }}{% endif %}
                </div>
              {% endwith %}
            </div>
            <div class="col-12">
              <label class="form-label">Tipo</label>
              {{ form.tipo }}
              <div class="form-text">Selecciona el rol adecuado para el usuario.</div>
              {% if form.tipo.errors %}<div class="invalid-feedback d-block">{{ form.tipo.errors|striptags }}</div>{% endif %}
            </div>
          </div>
        </div>

        <!-- ===== Seguridad ===== -->
        <div class="border rounded-3 p-3 mb-3 bg-white">
          <h6 class="text-uppercase text-muted mb-3">Seguridad</h6>
          <div class="row g-3">
            {% if modo == "crear" %}
              <div class="col-12">
                <label class="form-label">Contraseña <span class="text-danger">*</span></label>
                {{ form.password1 }}
                {% if form.password1.errors %}
                  <div class="alert alert-danger mt-2 mb-0">
                    <strong><i class="bi bi-exclamation-triangle"></i> Errores de contraseña:</strong>
                    <ul class="mb-0 mt-2">
                      {% for error in form.password1.errors %}
                        <li>{{ error }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
                
                <div class="password-help">
                  <strong><i class="bi bi-shield-lock"></i> Requisitos de contraseña:</strong>
                  <ul>
                    <li>Mínimo <strong>8 caracteres</strong></li>
                    <li>Al menos <strong>1 letra MAYÚSCULA</strong> (A-Z)</li>
                    <li>Al menos <strong>1 letra minúscula</strong> (a-z)</li>
                    <li>Al menos <strong>1 número</strong> (0-9)</li>
                    <li>Al menos <strong>1 carácter especial</strong> (!@#$%^&*...)</li>
                    <li><strong>Sin espacios</strong> en blanco</li>
                    <li><strong>No similar</strong> a tu información personal</li>
                  </ul>
                  <div class="mt-2">
                    <small class="text-muted">
                      <i class="bi bi-lightbulb"></i> <strong>Ejemplo:</strong> Sur@Voley2024!
                    </small>
                  </div>
                </div>
              </div>
              <div class="col-12">
                <label class="form-label">Confirmar contraseña <span class="text-danger">*</span></label>
                {{ form.password2 }}
                {% if form.password2.errors %}<div class="invalid-feedback d-block">{{ form.password2.errors|striptags }}</div>{% endif %}
              </div>
            {% else %}
              <div class="col-12">
                <label class="form-label">Nueva contraseña (opcional)</label>
                {{ form.password1 }}
                {% if form.password1.errors %}
                  <div class="alert alert-danger mt-2 mb-0">
                    <strong><i class="bi bi-exclamation-triangle"></i> Errores de contraseña:</strong>
                    <ul class="mb-0 mt-2">
                      {% for error in form.password1.errors %}
                        <li>{{ error }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
                <div class="form-text">Déjalo en blanco si no deseas cambiarla.</div>
                
                <div class="mt-2">
                  <a class="text-decoration-none" data-bs-toggle="collapse" href="#passwordReqs" role="button" aria-expanded="false">
                    <i class="bi bi-info-circle"></i> Ver requisitos de contraseña
                  </a>
                  <div class="collapse" id="passwordReqs">
                    <div class="password-help mt-2">
                      <ul class="mb-0">
                        <li>Mínimo <strong>8 caracteres</strong></li>
                        <li>Al menos <strong>1 letra MAYÚSCULA</strong></li>
                        <li>Al menos <strong>1 letra minúscula</strong></li>
                        <li>Al menos <strong>1 número</strong></li>
                        <li>Al menos <strong>1 carácter especial</strong> (!@#$%^&*...)</li>
                        <li><strong>Sin espacios</strong></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12">
                <label class="form-label">Confirmar nueva contraseña</label>
                {{ form.password2 }}
                {% if form.password2.errors %}<div class="invalid-feedback d-block">{{ form.password2.errors|striptags }}</div>{% endif %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Columna derecha -->
      <div class="col-12 col-lg-6">
        <!-- ===== Identificación ===== -->
        <div class="border rounded-3 p-3 mb-3 bg-white">
          <h6 class="text-uppercase text-muted mb-3">Identificación</h6>
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">RUN/DNI</label>
              {{ form.run }}
              {% if form.run.errors %}<div class="invalid-feedback d-block">{{ form.run.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Teléfono</label>
              {{ form.telefono }}
              {% if form.telefono.errors %}<div class="invalid-feedback d-block">{{ form.telefono.errors|striptags }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Primer nombre</label>
              {{ form.primer_nombre }}
              {% if form.primer_nombre.errors %}<div class="invalid-feedback d-block">{{ form.primer_nombre.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Segundo nombre</label>
              {{ form.segundo_nombre }}
              {% if form.segundo_nombre.errors %}<div class="invalid-feedback d-block">{{ form.segundo_nombre.errors|striptags }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Apellido paterno</label>
              {{ form.apellido_paterno }}
              {% if form.apellido_paterno.errors %}<div class="invalid-feedback d-block">{{ form.apellido_paterno.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Apellido materno</label>
              {{ form.apellido_materno }}
              {% if form.apellido_materno.errors %}<div class="invalid-feedback d-block">{{ form.apellido_materno.errors|striptags }}</div>{% endif %}
            </div>
          </div>
        </div>

        <!-- ===== Datos de Jugador (dinámico) ===== -->
        {% if form.fecha_nacimiento or form.tipo_sangre %}
          <div id="jugador-extra" class="border rounded-3 p-3 mb-3 bg-white" style="display:none;">
            <h6 class="text-uppercase text-muted mb-3">Datos de jugador</h6>
            <div class="row g-3">
              {% if form.fecha_nacimiento %}
                <div class="col-12 col-md-6">
                  <label class="form-label">
                    Fecha de nacimiento 
                    <span class="text-danger" id="requiredFecha" style="display:none;">*</span>
                  </label>
                  {{ form.fecha_nacimiento }}
                  {% if form.fecha_nacimiento.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.fecha_nacimiento.errors %}
                        {{ error }}<br>
                      {% endfor %}
                    </div>
                  {% endif %}
              
          
                  <!-- ✅ Indicador de edad calculada -->
                  <div id="edadIndicador" class="edad-info" style="display: none;">
                    <i class="bi bi-calendar-check"></i> 
                    <strong>Edad actual:</strong> <span id="edadValor"></span> años
                  </div>
                </div>
              {% endif %}
        {% endif %}
              {% if form.tipo_sangre %}
                <div class="col-12 col-md-6">
                  <label class="form-label">Tipo de sangre</label>
                  {{ form.tipo_sangre }}
                  {% if form.tipo_sangre.errors %}<div class="invalid-feedback d-block">{{ form.tipo_sangre.errors|striptags }}</div>{% endif %}
                </div>
              {% endif %}
              
              <div class="col-12">
                <label class="form-label">Equipo</label>
                {{ form.equipo }}
                {% if form.equipo.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.equipo.errors %}
                      {{ error }}<br>
                    {% endfor %}
                  </div>
                {% endif %}
                
                <!-- ✅ Información de categoría del equipo -->
                <div id="categoriaInfo" class="edad-info" style="display: none;">
                  <i class="bi bi-shield"></i> 
                  <strong>Categoría del equipo:</strong> 
                  <span id="categoriaValor"></span>
                  <br>
                  <small class="text-muted">
                    <i class="bi bi-info-circle"></i> 
                    <span id="edadRequerida"></span>
                  </small>
                </div>
                
                <!-- ✅ Advertencia de incompatibilidad -->
                <div id="advertenciaEdad" class="edad-warning" style="display: none;">
                  <i class="bi bi-exclamation-triangle"></i> 
                  <strong>Advertencia:</strong> <span id="mensajeAdvertencia"></span>
                </div>
                {% if form.colegio %}
                <div class="col-12">
                  <label class="form-label">Colegio</label>
                  {{ form.colegio }}
                  {% if form.colegio.errors %}<div class="invalid-feedback d-block">{{ form.colegio.errors|striptags }}</div>{% endif %}
                </div>
                {% endif %}
                {% if form.curso %}
                  <div class="col-12 col-md-6">
                    <label class="form-label">Curso</label>
                    {{ form.curso }}
                    {% if form.curso.errors %}<div class="invalid-feedback d-block">{{ form.curso.errors|striptags }}</div>{% endif %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
      </div>
    </div>

    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-primary" type="submit">
        {% if modo == "crear" %}<i class="bi bi-check2-circle"></i> Crear{% else %}<i class="bi bi-save"></i> Guardar{% endif %}
      </button>
      <a href="{% url 'usuarios_lista' %}" class="btn btn-outline-secondary">Cancelar</a>
    </div>
  </form>
</div>

{% block extra_js %}
<script>
(function() {
  const selectTipo = document.getElementById("id_tipo");
  const bloqueJugador = document.getElementById("jugador-extra");
  const FIELD_FECHA = document.getElementById("id_fecha_nacimiento");
  const FIELD_SANGRE = document.getElementById("id_tipo_sangre");
  const FIELD_EQUIPO = document.getElementById("id_equipo");
  const FIELD_COLEGIO = document.getElementById("id_colegio");
  const FIELD_CURSO = document.getElementById("id_curso")
  const requiredFecha = document.getElementById("requiredFecha");
  const emailField = document.getElementById("id_email");
  const emailFeedback = document.getElementById("email-error-feedback");

  if (emailField && emailFeedback) {
    let serverMessage = (emailFeedback.dataset.serverMessage || "").trim();
    const clientMessage = "Ingresa un correo electrónico válido. Ejemplo: usuario@dominio.com";

    if (serverMessage) {
      emailFeedback.textContent = serverMessage;
      emailFeedback.classList.add("d-block");
    } else {
      emailFeedback.textContent = "";
      emailFeedback.classList.remove("d-block");
    }

    emailField.addEventListener("invalid", function () {
      if (emailField.value.trim()) {
        emailField.setCustomValidity(clientMessage);
        emailFeedback.textContent = clientMessage;
        emailFeedback.classList.add("d-block");
      } else {
        emailField.setCustomValidity("");
        emailFeedback.textContent = "";
        emailFeedback.classList.remove("d-block");
      }
    });

    emailField.addEventListener("input", function () {
      emailField.setCustomValidity("");
      if (serverMessage) {
        serverMessage = "";
      }
      emailFeedback.textContent = "";
      emailFeedback.classList.remove("d-block");
    });
  }

  // Elementos de indicadores
  const edadIndicador = document.getElementById("edadIndicador");
  const edadValor = document.getElementById("edadValor");
  const categoriaInfo = document.getElementById("categoriaInfo");
  const categoriaValor = document.getElementById("categoriaValor");
  const edadRequerida = document.getElementById("edadRequerida");
  const advertenciaEdad = document.getElementById("advertenciaEdad");
  const mensajeAdvertencia = document.getElementById("mensajeAdvertencia");

  // ✅ Función para calcular edad
  function calcularEdad(fechaNacimiento) {
    const hoy = new Date();
    const nacimiento = new Date(fechaNacimiento);
    let edad = hoy.getFullYear() - nacimiento.getFullYear();
    const mes = hoy.getMonth() - nacimiento.getMonth();
    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
      edad--;
    }
    return edad;
  }

  // ✅ Función para obtener info de categoría
  function getInfoCategoria(categoriaText) {
    const lower = categoriaText.toLowerCase();
    if (lower.includes('sub-14') || lower.includes('sub14')) {
      return { nombre: 'Sub-14', maxEdad: 14, clase: 'categoria-sub14' };
    } else if (lower.includes('sub-16') || lower.includes('sub16')) {
      return { nombre: 'Sub-16', maxEdad: 16, clase: 'categoria-sub16' };
    } else if (lower.includes('sub-18') || lower.includes('sub18')) {
      return { nombre: 'Sub-18', maxEdad: 18, clase: 'categoria-sub18' };
    }
    return null;
  }

  // ✅ Validar edad y categoría
  function validarEdadCategoria() {
    if (!FIELD_FECHA || !FIELD_EQUIPO) return;
    
    const fechaNac = FIELD_FECHA.value;
    const equipoSelect = FIELD_EQUIPO;
    
    // Ocultar todo primero
    if (edadIndicador) edadIndicador.style.display = 'none';
    if (categoriaInfo) categoriaInfo.style.display = 'none';
    if (advertenciaEdad) advertenciaEdad.style.display = 'none';
    
    // Mostrar edad si hay fecha
    if (fechaNac && edadIndicador && edadValor) {
      const edad = calcularEdad(fechaNac);
      edadValor.textContent = edad;
      edadIndicador.style.display = 'block';
    }
    
    // Mostrar info de categoría si hay equipo
    if (equipoSelect.value && categoriaInfo) {
      const equipoTexto = equipoSelect.options[equipoSelect.selectedIndex].text;
      const infoCategoria = getInfoCategoria(equipoTexto);
      
      if (infoCategoria) {
        categoriaValor.innerHTML = `<span class="categoria-badge ${infoCategoria.clase}">${infoCategoria.nombre}</span>`;
        edadRequerida.textContent = `Edad máxima permitida: ${infoCategoria.maxEdad} años`;
        categoriaInfo.style.display = 'block';
        
        // Validar si hay incompatibilidad
        if (fechaNac) {
          const edad = calcularEdad(fechaNac);
          if (edad > infoCategoria.maxEdad) {
            mensajeAdvertencia.textContent = 
              `El jugador tiene ${edad} años y no puede estar en la categoría ${infoCategoria.nombre} ` +
              `(edad máxima: ${infoCategoria.maxEdad} años).`;
            advertenciaEdad.style.display = 'block';
          }
        }
      }
    }
  }

  // ✅ Toggle de sección jugador
  function toggleJugador() {
    if (!selectTipo || !bloqueJugador) return;
    const esJugador = selectTipo.value === "JUGAD";
    bloqueJugador.style.display = esJugador ? "" : "none";
    
    if (FIELD_FECHA) {
      FIELD_FECHA.required = esJugador;
      if (requiredFecha) requiredFecha.style.display = esJugador ? "" : "none";
    }
    if (FIELD_SANGRE) FIELD_SANGRE.required = false;
    
    if (esJugador) {
      validarEdadCategoria();
    }
  }

  // Event listeners
  if (selectTipo) {
    selectTipo.addEventListener("change", toggleJugador);
    toggleJugador();
  }

  if (FIELD_FECHA) {
    FIELD_FECHA.addEventListener("change", validarEdadCategoria);
  }

  if (FIELD_EQUIPO) {
    FIELD_EQUIPO.addEventListener("change", validarEdadCategoria);
  }

  // Validar al cargar (para modo edición)
  if (selectTipo && selectTipo.value === "JUGAD") {
    validarEdadCategoria();
  }
})();
</script>
{% endblock %}
{% endblock %}