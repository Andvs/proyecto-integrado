{% extends "base.html" %}
{% block titulo %}Visualización de Jugadores{% endblock titulo %}
{% block contenido %}
<div class="container mt-5">
    <h2 class="mb-4 text-center">Lista de Jugadores</h2>

    {# Buscador centrado #}
    <div class="row mb-4">
        <div class="col-md-8 offset-md-2">
            <form method="GET" class="d-flex">
                <input class="form-control me-2" type="search"
                        placeholder="Buscar por nombre, RUN, equipo o categoría..."
                        name="q" value="{{ search_query|default_if_none:'' }}">
                <button class="btn btn-primary" type="submit">Buscar</button>
            </form>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle text-center">
            <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>RUN</th>
                    <th>Equipo</th>
                    <th>Categoría</th>
                    <th>Entrenador</th>
                    <th>Activo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for j in page_obj %}
                <tr>
                    <td>{{ j.nombre }} {{ j.apellido }}</td>
                    <td>{{ j.run }}</td>
                    <td>{{ j.equipo.nombre }}</td>
                    <td>{{ j.equipo.categoria.nombre }}</td>
                    <td>{{ j.equipo.entrenador.nombre }}</td>
                    <td>
                        {% if j.activo %}
                            <span class="badge bg-success">Sí</span>
                        {% else %}
                            <span class="badge bg-danger">No</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'editar_jugador' j.id %}" class="btn btn-sm btn-outline-secondary">Editar</a>

                        {% if j.activo %}
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#confirmarAccionJugadorModal"
                                    data-jugador-id="{{ j.id }}"
                                    data-jugador-nombre="{{ j.nombre }} {{ j.apellido }}"
                                    data-accion="deshabilitar"
                                    data-next="{{ request.get_full_path }}">
                                Deshabilitar
                            </button>
                        {% else %}
                            <button type="button" class="btn btn-sm btn-outline-success"
                                    data-bs-toggle="modal"
                                    data-bs-target="#confirmarAccionJugadorModal"
                                    data-jugador-id="{{ j.id }}"
                                    data-jugador-nombre="{{ j.nombre }} {{ j.apellido }}"
                                    data-accion="habilitar"
                                    data-next="{{ request.get_full_path }}">
                                Habilitar
                            </button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No se encontraron jugadores.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if page_obj.has_other_pages %}
    <nav aria-label="Navegación de página">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}">&laquo;</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            {% for i in page_obj.paginator.page_range %}
                {% if page_obj.number == i %}
                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                {% else %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ i }}{% if search_query %}&q={{ search_query }}{% endif %}">{{ i }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}">&raquo;</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    <div class="text-center mt-2">
        <span class="text-muted">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}.</span>
    </div>

    <div class="text-center mt-4">
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">Volver al panel principal</a>
    </div>
</div>

<div class="modal fade" id="confirmarAccionJugadorModal" tabindex="-1" aria-labelledby="modalJugadorLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="modalJugadorLabel">Confirmar Acción</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
            <p id="modal-jugador-text"></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <a id="confirmar-jugador-btn" href="#" class="btn">Aceptar</a>
        </div>
        </div>
    </div>
</div>

<script>
const modalJug = document.getElementById('confirmarAccionJugadorModal');
modalJug.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const jugadorId = button.getAttribute('data-jugador-id');
    const jugadorNom = button.getAttribute('data-jugador-nombre');
    const accion = button.getAttribute('data-accion');
    const next = button.getAttribute('data-next');

    const texto = accion === "deshabilitar"
        ? `¿Seguro que deseas deshabilitar a "${jugadorNom}"?`
        : `¿Seguro que deseas habilitar a "${jugadorNom}"?`;

    const confirmarBtn = modalJug.querySelector('#confirmar-jugador-btn');
    confirmarBtn.textContent = accion === "deshabilitar" ? "Deshabilitar" : "Habilitar";
    confirmarBtn.className = accion === "deshabilitar" ? "btn btn-danger" : "btn btn-success";

    const baseUrl = accion === "deshabilitar"
        ? "{% url 'deshabilitar_jugador' 0 %}".replace('0', jugadorId)
        : "{% url 'habilitar_jugador' 0 %}".replace('0', jugadorId);

    confirmarBtn.href = baseUrl + "?next=" + encodeURIComponent(next);
    modalJug.querySelector('#modal-jugador-text').textContent = texto;
});
</script>
{% endblock %}
